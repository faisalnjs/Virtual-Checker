<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Upload - Virtual Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
    <link rel="stylesheet" href="https://unpkg.com/faz-quill-emoji@0.1.3/dist/faz.quill.emoji.css" type="text/css" />
    <link rel="stylesheet" href="../src/reset.css" />
    <link rel="stylesheet" href="../src/layout.css" />
    <link rel="stylesheet" href="../src/design.css" />
    <style>
        body {
            padding: 10px;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        * {
            font-family: "Figtree", sans-serif;
        }

        button#paste,
        button#submit,
        button#exit,
        button#ai {
            background: var(--accent-color, dodgerblue);
            width: -webkit-fill-available;
            border: 1px solid 1px solid var(--accent-color, aliceblue);
            border-radius: 5px;
            padding: 10px;
            line-height: 12.5px;
            font-size: 12.5px;
            font-weight: bold;
            color: var(--accent-text-color, white);
            height: unset;
        }

        button#ai {
            width: fit-content;
            padding: 0 9.5px;
        }

        button#paste:hover,
        button#submit:hover,
        button#exit:hover,
        button#ai:hover {
            opacity: 0.75;
        }

        button#submit {
            margin-top: 0.5em;
        }

        button#exit {
            display: none;
            margin-top: 0.5em;
        }

        button.success {
            background: mediumseagreen !important;
        }

        button.error {
            background: indianred !important;
        }

        input[type="text"] {
            height: 2.25em;
            padding: 0.1em 0.7em;
            border: none;
            border-radius: 0.4rem;
            background-color: var(--surface-color, #efefef);
            color: var(--text-color, black);
            width: -webkit-fill-available;
            cursor: pointer;
            font: 14px "Figtree", sans-serif;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.row {
            flex-direction: row;
            gap: 0.25em;
        }

        .input-group:not(.row),
        .input-group:has(#ai) {
            margin-bottom: 0.5em;
        }

        .filepond--hopper {
            background: var(--surface-color);
            margin-bottom: 0.5em;
        }

        .filepond--drop-label {
            color: var(--text-color);
        }
        .description {
            margin-top: 1em;
            max-width: unset;
        }
    </style>
</head>

<body>
    <div class="input-group row">
        <input type="text" placeholder="Question Text" />
        <button id="ai" onclick="ai()"><i class="bi bi-openai"></i></button>
    </div>
    <div id="correct-answers" class="input-group">
        <input type="text" data-correct-answer placeholder="Correct Answer" />
        <input type="text" data-correct-answer placeholder="Correct Answer" />
    </div>
    <div id="incorrect-answers" class="input-group">
        <div class="input-group row" data-incorrect-answer>
            <input type="text" placeholder="Incorrect Answer" />
            <input type="text" data-incorrect-answer-reason placeholder="Reason" />
        </div>
        <div class="input-group row" data-incorrect-answer>
            <input type="text" placeholder="Incorrect Answer" />
            <input type="text" data-incorrect-answer-reason placeholder="Reason" />
        </div>
    </div>
    <input type="file" />
    <button id="paste" onclick="paste()">Paste</button>
    <div class="description"></div>
    <button id="submit" onclick="submit()">Create</button>
    <button id="exit" onclick="exit()">Close & Next Question</button>
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://unpkg.com/faz-quill-emoji@0.1.3"></script>
    <script src="../src/modules/storage.js" type="module"></script>
    <script src="../src/themes/themes.js" type="module"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const question = urlParams.get('question');
        const syllabus = urlParams.get('syllabus');
        const segment = urlParams.get('segment');
        const startingQuestionId = urlParams.get('startingQuestionId');
        const startingQuestion = urlParams.get('startingQuestion');
        const period = urlParams.get('period');
        if (!question && !syllabus && !segment && !period) window.location.href = '/admin';
        const inputElement = document.querySelector('input[type="file"]');
        const questionElement = document.querySelector('input[type="file"]');
        const domain = ((window.location.hostname.search('check') != -1) || (window.location.hostname.search('127') != -1)) ? 'https://api.check.vssfalcons.com' : `http://${document.domain}:5000`;
        const server = domain + (question ? '/upload' : segment ? '/speedModeUpload' : syllabus ? '/syllabus' : '/roster');
        FilePond.registerPlugin(FilePondPluginFileValidateType, FilePondPluginImagePreview);
        const pond = FilePond.create(inputElement, {
            server,
            credits: false,
            allowMultiple: (question || segment) ? true : false,
            instantUpload: (question || segment) ? false : true,
            acceptedFileTypes: (question || segment) ? ['image/*'] : syllabus ? ['image/*', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] : ['text/csv'],
        });
        pond.on('initfile', (item) => {
            if (question) item.setMetadata('question', question);
            if (segment) item.setMetadata('segment', segment);
            if (syllabus) item.setMetadata('course', syllabus);
            if (period) item.setMetadata('period', period);
            if (startingQuestionId && startingQuestion) item.setMetadata('startingQuestionId', startingQuestionId);
            if (startingQuestionId && startingQuestion) item.setMetadata('startingQuestion', startingQuestion);
        });
        pond.on('processfilestart', (file) => {
            if (startingQuestionId && startingQuestion && !file.getMetadata('title')) {
                file.setMetadata('title', document.querySelectorAll('input[type="text"]')[0].value || startingQuestion);
                file.setMetadata('correctAnswers', [...document.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || []);
                file.setMetadata('incorrectAnswers', [...document.querySelectorAll('[data-incorrect-answer]')].map(a => a.value).filter(Boolean) || []);
                file.setMetadata('description', JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}');
                pond.processFile(file);
            };
        });
        pond.on('processfiles', (error, file) => {
            if (error) return;
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        });
        if (!navigator.clipboard) document.getElementById("paste").remove();
        async function paste() {
            var items = await navigator.clipboard.read();
            if (!items) return;
            items = items.filter(item => item.types.find(type => type.startsWith('image/')));
            const item = items[0];
            if (!item) return;
            pond.addFile(await item.getType(item.types.filter(type => type.startsWith('image/'))[0]));
        };
        var quill = null;
        if (!startingQuestionId || !startingQuestion) {
            document.querySelectorAll('.input-group').forEach(e => e.remove());
            document.querySelector('.description').remove();
            document.getElementById('submit').remove();
            document.getElementById('exit').remove();
        } else {
            var textareaContainer = document.querySelector('.description')
            var toolbar = document.createElement('div');
            toolbar.innerHTML = `<div id="toolbar-container">
                <span class="ql-formats">
                <select class="ql-font" tooltip="Font"></select>
                <select class="ql-size" tooltip="Text Size"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-bold" tooltip="Bold"></button>
                <button class="ql-italic" tooltip="Italic"></button>
                <button class="ql-underline" tooltip="Underline"></button>
                <button class="ql-strike" tooltip="Strikethrough"></button>
                <button class="ql-faz-emoji" tooltip="Emoji"></button>
                </span>
                <span class="ql-formats">
                <select class="ql-color" tooltip="Text Color"></select>
                <select class="ql-background" tooltip="Highlight"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-script" value="sub" tooltip="Subscript"></button>
                <button class="ql-script" value="super" tooltip="Superscript"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-header" value="1" tooltip="Heading"></button>
                <button class="ql-header" value="2" tooltip="Subheading"></button>
                <button class="ql-blockquote" tooltip="Blockquote"></button>
                <button class="ql-code-block" tooltip="Code Block"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-list" value="ordered" tooltip="Number List"></button>
                <button class="ql-list" value="bullet" tooltip="Bullet List"></button>
                <button class="ql-indent" value="-1" tooltip="Remove Indent"></button>
                <button class="ql-indent" value="+1" tooltip="Indent"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-direction" value="rtl" tooltip="Text Direction"></button>
                <select class="ql-align" tooltip="Alignment"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-link" tooltip="Link"></button>
                <button class="ql-image" tooltip="Image"></button>
                <button class="ql-video" tooltip="Video"></button>
                <button class="ql-formula" tooltip="LaTeX"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-clean" tooltip="Clear Formatting"></button>
                <button data-clear-rich-content tooltip="Clear Description"><i class="bi bi-x-lg"></i></button>
                </span>
                <span class="ql-formats">
                <button data-export-rich-content tooltip="Export To Clipboard"><i class="bi bi-clipboard-fill"></i></button>
                <button data-import-rich-content tooltip="Import From Clipboard"><i class="bi bi-clipboard-plus-fill"></i></button>
                </span>
                <span class="ql-formats">
                <button data-undo-rich-content tooltip="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button data-redo-rich-content tooltip="Redo"><i class="bi bi-arrow-clockwise"></i></button>
                </span>
            </div>`;
            textareaContainer.appendChild(toolbar);
            var textarea = document.createElement('div');
            textareaContainer.appendChild(textarea);
            quill = new Quill(textarea, {
                modules: {
                    syntax: true,
                    toolbar,
                    fazEmoji: {
                        collection: 'fluent-emoji',
                    },
                },
                placeholder: 'Add some written content to your question...',
                theme: 'snow'
            });
            quill.on('text-change', (delta) => {
                var pastedLatex = delta.ops.find(op => Object.keys(op).includes('insert'))?.insert;
                if (pastedLatex && (typeof pastedLatex === 'string')) {
                    const latexMatches = [...pastedLatex.matchAll(/(\$\$(.+?)\$\$)|(?<!\\)\$(.+?)(?<!\\)\$/gs)];
                    latexMatches.forEach(match => {
                        const fullMatch = match[0];
                        const innerLatex = match[2] || match[3];
                        const index = pastedLatex.indexOf(fullMatch);
                        quill.deleteText(quill.getSelection(true)?.index + index, fullMatch.length);
                        quill.insertEmbed(quill.getSelection(true)?.index + index, 'formula', innerLatex);
                        pastedLatex = pastedLatex.replace(fullMatch, ' ');
                    });
                    pastedLatex = pastedLatex.replace(/(?<!\\)\$/g, '');
                }
            });
        };
        var submitSuccess = false;
        async function submit() {
            if (pond.getFiles().length != 0) {
                pond.processFiles();
            } else {
                await fetch(server, {
                    method: 'POST',
                    body: JSON.stringify({
                        question: question || null,
                        segment: segment || null,
                        course: syllabus || null,
                        period: period || null,
                        startingQuestionId: startingQuestionId || null,
                        startingQuestion: startingQuestion || null,
                        description: JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}',
                        title: document.querySelectorAll('input[type="text"]')[0].value || startingQuestion,
                        correctAnswers: [...document.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || [],
                        incorrectAnswers: [...document.querySelectorAll('[data-incorrect-answer]')].map(a => a.value).filter(Boolean) || [],
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            submitSuccess = false;
                            document.getElementById('exit').classList.add('error');
                            setTimeout(() => {
                                document.getElementById('exit').classList.remove('error');
                            }, 2000);
                            alert(data.error);
                        } else {
                            submitSuccess = true;
                            document.getElementById('submit').innerText = 'Success';
                            document.getElementById('submit').classList.add('success');
                            document.getElementById('exit').style.display = 'block';
                            setTimeout(() => {
                                document.getElementById('submit').innerText = 'Save';
                                document.getElementById('submit').classList.remove('success');
                            }, 2000);
                        };
                    });
            };
        };
        async function exit() {
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        };
        function startLoader() {
            const loader = document.getElementById("loader");
            if (loader) loader.classList.add("active");
        };
        function stopLoader() {
            const loader = document.getElementById("loader");
            if (loader) loader.classList.remove("active");
        };
    </script>
</body>

</html>