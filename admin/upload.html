<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Upload - Virtual Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
    <link rel="stylesheet" href="https://unpkg.com/faz-quill-emoji@0.1.3/dist/faz.quill.emoji.css" type="text/css" />
    <link rel="stylesheet" href="../src/reset.css" />
    <link rel="stylesheet" href="../src/layout.css" />
    <link rel="stylesheet" href="../src/design.css" />
    <style>
        body {
            padding: 10px;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        * {
            font-family: "Figtree", sans-serif;
        }

        button#paste,
        button#submit,
        button#exit,
        button#add-answers,
        button#remove-answers,
        button#ai {
            background: var(--accent-color, dodgerblue);
            width: -webkit-fill-available;
            border: 1px solid 1px solid var(--accent-color, aliceblue);
            border-radius: 5px;
            padding: 10px;
            line-height: 12.5px;
            font-size: 12.5px;
            font-weight: bold;
            color: var(--accent-text-color, white);
            height: unset;
        }

        button#add-answers,
        button#remove-answers {
            background: var(--surface-color, #efefef);
            color: var(--text-color, black);
        }

        button#paste:hover,
        button#submit:hover,
        button#exit:hover,
        button#add-answers:hover,
        button#remove-answers:hover,
        button#ai:hover {
            opacity: 0.75;
        }

        [square] {
            padding: 2px 9.5px 0 9.5px !important;
            width: fit-content !important;
            min-width: unset;
        }

        button#submit {
            margin-top: 0.5em;
        }

        button#exit {
            display: none;
            margin-top: 0.5em;
        }

        input[type="text"] {
            height: 2.25em;
            padding: 0.1em 0.7em;
            border: none;
            border-radius: 0.4rem;
            background-color: var(--surface-color, #efefef);
            color: var(--text-color, black);
            width: -webkit-fill-available;
            cursor: pointer;
            font: 14px "Figtree", sans-serif;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.row {
            flex-direction: row;
            gap: 0.25em;
        }

        .input-group:not(.row),
        .input-group:has(#ai) {
            margin-bottom: 0.5em;
        }

        .filepond--root {
            background: var(--surface-color);
            margin-bottom: 0.5em;
            border-radius: 0.4rem;
        }

        .filepond--root * {
            background: transparent;
        }

        .filepond--drop-label {
            color: var(--text-color);
            border-radius: 0.4rem;
        }

        .description {
            margin-top: 1em;
            max-width: unset;
        }
    </style>
</head>

<body>
    <div class="input-group row">
        <input type="text" placeholder="Question Text" />
        <button square id="add-answers" onclick="addAnswers()"><i class="bi bi-plus"></i></button>
        <button square id="remove-answers" onclick="removeAnswers()"><i class="bi bi-dash"></i></button>
        <button square id="ai" onclick="ai()"><i class="bi bi-openai"></i></button>
    </div>
    <div id="correct-answers" class="input-group">
        <input type="text" data-correct-answer placeholder="Correct Answer" />
        <input type="text" data-correct-answer placeholder="Correct Answer" />
    </div>
    <div id="incorrect-answers" class="input-group">
        <div class="input-group row" data-incorrect-answer>
            <input type="text" placeholder="Incorrect Answer" />
            <input type="text" data-incorrect-answer-reason placeholder="Reason" />
        </div>
        <div class="input-group row" data-incorrect-answer>
            <input type="text" placeholder="Incorrect Answer" />
            <input type="text" data-incorrect-answer-reason placeholder="Reason" />
        </div>
    </div>
    <input type="file" />
    <button id="paste" onclick="paste()">Paste</button>
    <div class="description"></div>
    <button id="submit" onclick="submit()">Create</button>
    <button id="exit" onclick="exit()">Close & Next Question</button>
    <div id="loader">
        <svg xmlns="http://www.w3.org/2000/svg" height="2.5em" viewBox="0 0 1041 732" fill="none"
            class="virtual-checker-logo">
            <path
                d="M1001.56 250.595C983.616 254.368 892.908 369.961 882.983 372.138C873.058 374.314 843.39 317.676 827.439 319.483C811.489 321.291 784.543 340.121 788.414 358.53C792.284 376.94 862.808 450.073 882.983 450.241C903.158 450.409 1037.91 305.154 1040.6 289.631C1043.28 274.109 1019.51 246.823 1001.56 250.595Z"
                fill="currentColor" />
            <path
                d="M189.838 59.888C202.279 55.741 210.44 56.363 217.578 59.931C224.715 63.5 230.493 70.81 235.656 86.298C251.225 133.005 278.027 213.412 299.189 276.896C304.344 292.362 312.472 296.957 322.252 296.957C332.033 296.957 339.718 293.692 345.627 275.965C360.443 231.517 378.763 176.556 396.583 123.097C430.426 21.567 472.963 0 567.37 0C702.785 0 897.037 0 984.213 0C1007.19 0 1013.22 4.649 1018.88 12.496C1024.53 20.342 1025.91 30.927 1020.96 45.757C1003.43 98.372 978.676 172.62 965.135 213.242C958.535 233.041 942.92 244.474 922.051 244.44C867.547 244.351 734.987 244.117 660.22 243.996C626.461 243.941 609.299 256.289 598.623 288.316C585.437 327.874 567.7 381.085 553.255 424.42C547.69 441.115 549.36 457.81 557.708 469.392C566.057 480.975 578.691 487.839 596.163 487.839C665.057 487.839 769.309 487.839 828.841 487.839C841.883 487.839 850.611 492.488 856.266 500.334C861.921 508.18 863.336 518.639 859.639 529.731C842.137 582.235 816.643 658.717 803.139 699.23C797.202 717.039 778.155 731.758 759.383 731.758C688.339 731.758 487.826 731.758 340.593 731.758C241.323 731.758 180.603 692.479 149.211 598.303C101.094 453.954 30.348 241.716 3.64795 161.614C-1.50905 146.144 -0.672047 138.629 2.89595 131.492C6.46495 124.354 10.977 119.509 28.36 113.714C72.841 98.887 145.357 74.715 189.838 59.888Z"
                fill="currentColor" />
        </svg>
    </div>
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://unpkg.com/faz-quill-emoji@0.1.3"></script>
    <script src="../src/modules/storage.js" type="module"></script>
    <script src="../src/themes/themes.js" type="module"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const question = urlParams.get('question');
        const syllabus = urlParams.get('syllabus');
        const segment = urlParams.get('segment');
        const startingQuestionId = urlParams.get('startingQuestionId');
        const startingQuestion = urlParams.get('startingQuestion');
        const period = urlParams.get('period');
        const course = urlParams.get('course');
        const platform = urlParams.get('platform');
        if (!question && !syllabus && !segment && !period && !course) window.location.href = '/admin';
        const inputElement = document.querySelector('input[type="file"]');
        const questionElement = document.querySelector('input[type="file"]');
        const domain = ((window.location.hostname.search('check') != -1) || (window.location.hostname.search('127') != -1)) ? 'https://api.check.vssfalcons.com' : `http://${document.domain}:5000`;
        const server = domain + (course ? '/announcement': question ? '/upload' : segment ? '/speedModeUpload' : syllabus ? '/syllabus' : '/roster');
        FilePond.registerPlugin(FilePondPluginFileValidateType, FilePondPluginImagePreview);
        const pond = FilePond.create(inputElement, {
            server,
            credits: false,
            allowMultiple: (question || segment) ? true : false,
            instantUpload: (question || segment) ? false : true,
            acceptedFileTypes: (course || question || segment) ? ['image/*'] : syllabus ? ['image/*', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] : ['text/csv'],
        });
        pond.on('initfile', (item) => {
            if (question) item.setMetadata('question', question);
            if (segment) item.setMetadata('segment', segment);
            if (syllabus) item.setMetadata('course', syllabus);
            if (period) item.setMetadata('period', period);
            if (course) item.setMetadata('course', course);
            if (platform) item.setMetadata('platform', platform);
            if (startingQuestionId && startingQuestion) item.setMetadata('startingQuestionId', startingQuestionId);
            if (startingQuestionId && startingQuestion) item.setMetadata('startingQuestion', startingQuestion);
        });
        pond.on('processfilestart', (file) => {
            if (startingQuestionId && startingQuestion && !file.getMetadata('title')) {
                file.setMetadata('title', document.querySelectorAll('input[type="text"]')[0].value || startingQuestion);
                file.setMetadata('correctAnswers', JSON.stringify([...document.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || []));
                file.setMetadata('incorrectAnswers', JSON.stringify([...document.querySelectorAll('[data-incorrect-answer]')].map(a => {
                    return { 'answer': a.querySelector('input').value, 'reason': a.querySelector('input[data-incorrect-answer-reason]').value };
                }).filter(a => a.answer !== '' && a.reason !== '') || []));
                file.setMetadata('description', JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}');
                pond.processFile(file);
            };
        });
        pond.on('processfiles', (error, file) => {
            if (error) return;
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        });
        if (!navigator.clipboard) document.getElementById("paste").remove();
        async function paste() {
            var items = await navigator.clipboard.read();
            if (!items) return;
            items = items.filter(item => item.types.find(type => type.startsWith('image/')));
            const item = items[0];
            if (!item) return;
            pond.addFile(await item.getType(item.types.filter(type => type.startsWith('image/'))[0]));
        };
        var quill = null;
        if (!startingQuestionId || !startingQuestion) {
            document.querySelectorAll('.input-group').forEach(e => e.remove());
            document.querySelector('.description').remove();
            document.getElementById('submit').remove();
            document.getElementById('exit').remove();
        } else {
            var textareaContainer = document.querySelector('.description')
            var toolbar = document.createElement('div');
            toolbar.innerHTML = `<div id="toolbar-container">
                <span class="ql-formats">
                <select class="ql-font" tooltip="Font"></select>
                <select class="ql-size" tooltip="Text Size"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-bold" tooltip="Bold"></button>
                <button class="ql-italic" tooltip="Italic"></button>
                <button class="ql-underline" tooltip="Underline"></button>
                <button class="ql-strike" tooltip="Strikethrough"></button>
                <button class="ql-faz-emoji" tooltip="Emoji"></button>
                </span>
                <span class="ql-formats">
                <select class="ql-color" tooltip="Text Color"></select>
                <select class="ql-background" tooltip="Highlight"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-script" value="sub" tooltip="Subscript"></button>
                <button class="ql-script" value="super" tooltip="Superscript"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-header" value="1" tooltip="Heading"></button>
                <button class="ql-header" value="2" tooltip="Subheading"></button>
                <button class="ql-blockquote" tooltip="Blockquote"></button>
                <button class="ql-code-block" tooltip="Code Block"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-list" value="ordered" tooltip="Number List"></button>
                <button class="ql-list" value="bullet" tooltip="Bullet List"></button>
                <button class="ql-indent" value="-1" tooltip="Remove Indent"></button>
                <button class="ql-indent" value="+1" tooltip="Indent"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-direction" value="rtl" tooltip="Text Direction"></button>
                <select class="ql-align" tooltip="Alignment"></select>
                </span>
                <span class="ql-formats">
                <button class="ql-link" tooltip="Link"></button>
                <button class="ql-image" tooltip="Image"></button>
                <button class="ql-video" tooltip="Video"></button>
                <button class="ql-formula" tooltip="LaTeX"></button>
                </span>
                <span class="ql-formats">
                <button class="ql-clean" tooltip="Clear Formatting"></button>
                <button data-clear-rich-content tooltip="Clear Description"><i class="bi bi-x-lg"></i></button>
                </span>
                <span class="ql-formats">
                <button data-export-rich-content tooltip="Export To Clipboard"><i class="bi bi-clipboard-fill"></i></button>
                <button data-import-rich-content tooltip="Import From Clipboard"><i class="bi bi-clipboard-plus-fill"></i></button>
                </span>
                <span class="ql-formats">
                <button data-undo-rich-content tooltip="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button data-redo-rich-content tooltip="Redo"><i class="bi bi-arrow-clockwise"></i></button>
                </span>
            </div>`;
            textareaContainer.appendChild(toolbar);
            var textarea = document.createElement('div');
            textareaContainer.appendChild(textarea);
            quill = new Quill(textarea, {
                modules: {
                    syntax: true,
                    toolbar,
                    fazEmoji: {
                        collection: 'fluent-emoji',
                    },
                },
                placeholder: 'Add some written content to your question...',
                theme: 'snow'
            });
            quill.on('text-change', (delta) => {
                var pastedLatex = delta.ops.find(op => Object.keys(op).includes('insert'))?.insert;
                if (pastedLatex && (typeof pastedLatex === 'string')) {
                    const latexMatches = [...pastedLatex.matchAll(/(\$\$(.+?)\$\$)|(?<!\\)\$(.+?)(?<!\\)\$/gs)];
                    latexMatches.forEach(match => {
                        const fullMatch = match[0];
                        const innerLatex = match[2] || match[3];
                        const index = pastedLatex.indexOf(fullMatch);
                        quill.deleteText(quill.getSelection(true)?.index + index, fullMatch.length);
                        quill.insertEmbed(quill.getSelection(true)?.index + index, 'formula', innerLatex);
                        pastedLatex = pastedLatex.replace(fullMatch, ' ');
                    });
                    pastedLatex = pastedLatex.replace(/(?<!\\)\$/g, '');
                }
            });
        };
        var submitSuccess = false;
        async function submit() {
            if (pond.getFiles().length != 0) {
                pond.processFiles();
            } else {
                await fetch(server, {
                    method: 'POST',
                    body: JSON.stringify({
                        question: question || null,
                        segment: segment || null,
                        course: syllabus || null,
                        period: period || null,
                        startingQuestionId: startingQuestionId || null,
                        startingQuestion: startingQuestion || null,
                        description: JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}',
                        title: document.querySelectorAll('input[type="text"]')[0].value || startingQuestion,
                        correctAnswers: [...document.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || [],
                        incorrectAnswers: [...document.querySelectorAll('[data-incorrect-answer]')].map(a => {
                            return { 'answer': a.querySelector('input').value, 'reason': a.querySelector('input[data-incorrect-answer-reason]').value };
                        }).filter(a => a.answer !== '' && a.reason !== '') || [],
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            submitSuccess = false;
                            document.getElementById('exit').classList.add('error');
                            setTimeout(() => {
                                document.getElementById('exit').classList.remove('error');
                            }, 2000);
                            alert(data.error);
                        } else {
                            submitSuccess = true;
                            document.getElementById('submit').innerText = 'Success';
                            document.getElementById('submit').classList.add('success');
                            document.getElementById('exit').style.display = 'block';
                            setTimeout(() => {
                                document.getElementById('submit').innerText = 'Save';
                                document.getElementById('submit').classList.remove('success');
                            }, 2000);
                        };
                    });
            };
        };
        async function exit() {
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        };
        function startLoader() {
            const loader = document.getElementById("loader");
            if (loader) loader.classList.add("active");
        };
        function stopLoader() {
            const loader = document.getElementById("loader");
            if (loader) loader.classList.remove("active");
        };
        function addAnswers() {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Correct Answer';
            input.setAttribute('data-correct-answer', '');
            document.getElementById('correct-answers').appendChild(input);
            const group = document.createElement('div');
            group.classList.add('input-group', 'row');
            group.setAttribute('data-incorrect-answer', '');
            const input2 = document.createElement('input');
            input2.type = 'text';
            input2.placeholder = 'Incorrect Answer';
            group.appendChild(input2);
            const reason = document.createElement('input');
            reason.type = 'text';
            reason.placeholder = 'Reason';
            reason.setAttribute('data-incorrect-answer-reason', '');
            group.appendChild(reason);
            document.getElementById('incorrect-answers').appendChild(group);
        };
        function removeAnswers() {
            [...document.querySelectorAll('[data-correct-answer]')].filter(e => e.value === '').forEach(e => e.remove());
            [...document.querySelectorAll('[data-incorrect-answer]')].filter(e => e.querySelector('input').value === '' && e.querySelector('input[data-incorrect-answer-reason]').value === '').forEach(e => e.remove());
        };
        async function ai() {
            var images = [];
            var pondFiles = pond.getFiles();
            if (pondFiles.length !== 0) {
                const readPromises = pondFiles.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = function () {
                            resolve(reader.result);
                        };
                        reader.onerror = reject;
                        if (file.file) reader.readAsDataURL(file.file);
                        else resolve(null);
                    });
                });
                images = await Promise.all(readPromises);
            };
            images = images.filter(image => image !== null);
            images = [...new Set(images)];
            var description = quill.getText().replaceAll('\\n', ' ').replaceAll('  ', ' ').trim() || null;
            if (images.length || description) {
                startLoader();
                await fetch(domain + '/ai/q', {
                    method: 'POST',
                    body: JSON.stringify({
                        OpenAI_API_Key: "sk-proj-18b3a02f4fb35e8a8421948667fbacf7_2ac9b775227456bb9d53d370cc299da7937deb6b_184751e482b7_f157c538a800",
                        title: document.querySelectorAll('input[type="text"]')[0].value || startingQuestion,
                        description,
                        images,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        stopLoader();
                        const output = data.o;
                        if (data.error || !data.o) {
                            document.getElementById('ai').classList.add('error');
                            setTimeout(() => {
                                document.getElementById('ai').classList.remove('error');
                            }, 2000);
                            alert(data.error);
                        } else {
                            const aiCorrectAnswers = output.correct || [];
                            const aiIncorrectAnswers = output.incorrect || [];
                            removeAnswers();
                            aiCorrectAnswers.forEach(answer => {
                                if (!answer || [...document.querySelectorAll('[data-correct-answer]')].find(e => e.value.toLowerCase() === answer.toLowerCase())) return;
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.value = answer;
                                input.setAttribute('data-correct-answer', '');
                                document.getElementById('correct-answers').appendChild(input);
                            });
                            aiIncorrectAnswers.forEach(answer => {
                                if (!answer.answer || !answer.reason || [...document.querySelectorAll('[data-incorrect-answer] input:not([data-incorrect-answer-reason])')].find(e => e.value.toLowerCase() === answer.answer.toLowerCase())) return;
                                const group = document.createElement('div');
                                group.classList.add('input-group', 'row');
                                group.setAttribute('data-incorrect-answer', '');
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.value = answer.answer;
                                group.appendChild(input);
                                const reason = document.createElement('input');
                                reason.type = 'text';
                                reason.value = answer.reason;
                                reason.setAttribute('data-incorrect-answer-reason', '');
                                group.appendChild(reason);
                                document.getElementById('incorrect-answers').appendChild(group);
                            });
                            document.getElementById('ai').classList.add('success');
                            setTimeout(() => {
                                document.getElementById('ai').classList.remove('success');
                            }, 2000);
                        };
                    })
                    .catch(error => {
                        document.getElementById('ai').classList.add('error');
                        setTimeout(() => {
                            document.getElementById('ai').classList.remove('error');
                        }, 2000);
                        alert(error);
                    });
            } else {
                alert('Image(s) or description required.');
                document.getElementById('ai').classList.add('error');
                setTimeout(() => {
                    document.getElementById('ai').classList.remove('error');
                }, 2000);
                return;
            };
        };
    </script>
</body>

</html>