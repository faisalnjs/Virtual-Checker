<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Upload - Virtual Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
    <link rel="stylesheet" href="https://unpkg.com/faz-quill-emoji@0.1.3/dist/faz.quill.emoji.css" type="text/css" />
    <link rel="stylesheet" href="../src/reset.css" />
    <link rel="stylesheet" href="../src/layout.css" />
    <link rel="stylesheet" href="../src/design.css" />
    <style>
        body {
            padding: 1vw !important;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        * {
            font-family: "Figtree", sans-serif;
        }

        .uploaders {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 7.5px;
        }

        .uploader:not(:only-child) {
            border: 2px solid dodgerblue;
            padding: 7.5px;
        }

        .uploaders:has(.uploader:not(:only-child)) {
            margin-bottom: calc(32.5px + 2vw);
        }

        .uploaders:has(.uploader:not(:only-child)) #submit-exit {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            gap: 1vw;
            padding: calc(1vw - 0.5em) 1vw 1vw 1vw;
            z-index: 1000;
        }

        .uploaders:has(.uploader:not(:only-child)) #submit::after {
            content: ' All';
        }

        button#paste,
        button#submit,
        button#next,
        button#exit,
        button#add-answers,
        button#remove-answers,
        button#ai,
        button#copy,
        button#remove,
        button#stem {
            background: var(--accent-color, dodgerblue);
            width: -webkit-fill-available;
            border: 1px solid 1px solid var(--accent-color, aliceblue);
            border-radius: 5px;
            padding: 10px;
            line-height: 12.5px;
            font-size: 12.5px;
            font-weight: bold;
            color: var(--accent-text-color, white);
            height: unset;
        }

        button#add-answers,
        button#remove-answers,
        button#copy,
        button#remove,
        button#stem {
            background: var(--surface-color, #efefef);
            color: var(--text-color, black);
        }

        button#paste:hover,
        button#submit:hover,
        button#next:hover,
        button#exit:hover,
        button#add-answers:hover,
        button#remove-answers:hover,
        button#ai:hover,
        button#copy:hover,
        button#remove:hover,
        button#stem:hover {
            opacity: 0.75;
        }

        [square] {
            padding: 2px 9.5px 0 9.5px !important;
            width: fit-content !important;
            min-width: unset;
        }

        button#submit {
            margin-top: 0.5em;
        }

        button#next,
        button#exit {
            display: none;
            margin-top: 0.5em;
        }

        input[type="text"] {
            height: 2.25em;
            padding: 0.1em 0.7em;
            border: none;
            border-radius: 0.4rem;
            background-color: var(--surface-color, #efefef);
            color: var(--text-color, black);
            width: -webkit-fill-available;
            cursor: pointer;
            font: 14px "Figtree", sans-serif;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.row {
            flex-direction: row;
            gap: 0.25em;
        }

        .input-group:not(.row),
        .input-group:has(#ai),
        .input-group:has([data-question-number]) {
            margin-bottom: 0.5em;
        }

        .filepond--root {
            background: var(--surface-color);
            margin-bottom: 0.5em;
            border-radius: 0.4rem;
        }

        .filepond--root * {
            background: transparent;
        }

        .filepond--drop-label {
            color: var(--text-color);
            border-radius: 0.4rem;
        }

        .description {
            margin-top: 1em;
            max-width: unset;
        }

        .input-group:has([data-question-number]) {
            gap: 0;
        }

        [data-question-number] {
            background: transparent !important;
            padding: 0 !important;
            font-weight: bold !important;
            height: -webkit-fill-available !important;
            min-height: unset !important;
            padding-left: 5px !important;
        }

        #stem.active {
            background: var(--accent-color, dodgerblue);
            color: var(--accent-text-color, white);
        }

        #stem.active i.bi-diagram-3 {
            display: none;
        }

        #stem:not(.active) i.bi-diagram-3-fill {
            display: none;
        }
    </style>
</head>

<body>
    <div class="uploaders"></div>
    <div id="loader">
        <svg xmlns="http://www.w3.org/2000/svg" height="2.5em" viewBox="0 0 1041 732" fill="none"
            class="virtual-checker-logo">
            <path
                d="M1001.56 250.595C983.616 254.368 892.908 369.961 882.983 372.138C873.058 374.314 843.39 317.676 827.439 319.483C811.489 321.291 784.543 340.121 788.414 358.53C792.284 376.94 862.808 450.073 882.983 450.241C903.158 450.409 1037.91 305.154 1040.6 289.631C1043.28 274.109 1019.51 246.823 1001.56 250.595Z"
                fill="currentColor" />
            <path
                d="M189.838 59.888C202.279 55.741 210.44 56.363 217.578 59.931C224.715 63.5 230.493 70.81 235.656 86.298C251.225 133.005 278.027 213.412 299.189 276.896C304.344 292.362 312.472 296.957 322.252 296.957C332.033 296.957 339.718 293.692 345.627 275.965C360.443 231.517 378.763 176.556 396.583 123.097C430.426 21.567 472.963 0 567.37 0C702.785 0 897.037 0 984.213 0C1007.19 0 1013.22 4.649 1018.88 12.496C1024.53 20.342 1025.91 30.927 1020.96 45.757C1003.43 98.372 978.676 172.62 965.135 213.242C958.535 233.041 942.92 244.474 922.051 244.44C867.547 244.351 734.987 244.117 660.22 243.996C626.461 243.941 609.299 256.289 598.623 288.316C585.437 327.874 567.7 381.085 553.255 424.42C547.69 441.115 549.36 457.81 557.708 469.392C566.057 480.975 578.691 487.839 596.163 487.839C665.057 487.839 769.309 487.839 828.841 487.839C841.883 487.839 850.611 492.488 856.266 500.334C861.921 508.18 863.336 518.639 859.639 529.731C842.137 582.235 816.643 658.717 803.139 699.23C797.202 717.039 778.155 731.758 759.383 731.758C688.339 731.758 487.826 731.758 340.593 731.758C241.323 731.758 180.603 692.479 149.211 598.303C101.094 453.954 30.348 241.716 3.64795 161.614C-1.50905 146.144 -0.672047 138.629 2.89595 131.492C6.46495 124.354 10.977 119.509 28.36 113.714C72.841 98.887 145.357 74.715 189.838 59.888Z"
                fill="currentColor" />
        </svg>
    </div>
    <script
        src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://unpkg.com/faz-quill-emoji@0.1.3"></script>
    <script src="../src/modules/storage.js" type="module"></script>
    <script src="../src/themes/themes.js" type="module"></script>
    <script src="../src/modules/ui.js" type="module"></script>
    <script type="module">
        import * as ui from "/src/modules/ui.js";
        import storage from "/src/modules/storage.js";
        const urlParams = new URLSearchParams(window.location.search);
        const question = urlParams.get('question');
        const syllabus = urlParams.get('syllabus');
        const segment = urlParams.get('segment');
        var startingQuestionId = urlParams.get('startingQuestionId');
        var startingQuestion = urlParams.get('startingQuestion');
        const period = urlParams.get('period');
        const course = urlParams.get('course');
        const platform = urlParams.get('platform');
        const originalWindowWidth = urlParams.get('w');
        const originalWindowHeight = urlParams.get('h');
        const originalWindowY = urlParams.get('t');
        const originalWindowX = urlParams.get('l');
        const allowMultiple = startingQuestion && startingQuestionId && originalWindowHeight && originalWindowY && originalWindowX;
        if (!question && !syllabus && !segment && !period && !course) window.location.href = '/admin';
        const domain = ((window.location.hostname.search('check') != -1) || (window.location.hostname.search('127') != -1)) ? 'https://api.check.vssfalcons.com' : `http://${document.domain}:5000`;
        const server = domain + (course ? '/announcement' : question ? '/upload' : segment ? '/speedModeUpload' : syllabus ? '/syllabus' : '/roster');
        var submitSuccess = false;
        var uploaders = [];
        FilePond.registerPlugin(FilePondPluginFileValidateType, FilePondPluginImagePreview);
        function startLoader() {
            const loader = uploader.querySelector('#loader');
            if (loader) loader.classList.add('active');
        };
        function stopLoader() {
            const loader = uploader.querySelector('#loader');
            if (loader) loader.classList.remove('active');
        };
        async function next() {
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        };
        async function exit() {
            window.opener.postMessage('exitToCourse', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            setTimeout(() => {
                window.close();
            }, 500);
        };
        function createUploader(event = null, number = null) {
            const isMultiple = document.querySelector('.uploader') && originalWindowWidth && originalWindowHeight && originalWindowY && originalWindowX;
            if (isMultiple) {
                window.resizeTo(originalWindowWidth, originalWindowHeight);
                window.moveTo(originalWindowX, originalWindowY);
                startingQuestionId++;
                startingQuestion = (number || startingQuestion).replace(/(\d+)([a-z]*)$/, (match, num, suffix) => {
                    return !suffix ? (parseInt(num, 10) + 1).toString() : ((suffix === 'z') ? ((parseInt(num, 10) + 1) + 'a') : (num + String.fromCharCode(suffix.charCodeAt(0) + 1)));
                });
            }
            window.opener.postMessage(`${startingQuestionId};+;${startingQuestion}`, window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
            const uploaderQuestionId = startingQuestionId;
            const uploaderQuestion = startingQuestion;
            var uploader = document.createElement('div');
            uploader.id = uploaderQuestionId;
            uploader.classList.add('uploader');
            uploader.innerHTML = `
                <div class="input-group row">
                    <b>Question</b>
                    <input type="text" placeholder="${uploaderQuestion}" value="${uploaderQuestion}" data-question-number />
                </div>
                <div class="input-group row">
                    <input type="text" placeholder="Question Title" data-question-text />
                    <button square id="add-answers"><i class="bi bi-plus"></i></button>
                    <button square id="remove-answers"><i class="bi bi-dash"></i></button>
                    <button square id="ai"><i class="bi bi-openai"></i></button>
                    ${allowMultiple ? `<button square id="stem" ${isMultiple ? '' : 'class="active"'}><i class="bi bi-diagram-3"></i><i class="bi bi-diagram-3-fill"></i></button>` : ''}
                    ${isMultiple ? '<button square id="remove"><i class="bi bi-dash-circle-dotted"></i></button>' : ''}
                    ${allowMultiple ? '<button square id="copy"><i class="bi bi-plus-circle-dotted"></i></button>' : ''}
                </div>
                <div id="correct-answers" class="input-group">
                    <input type="text" data-correct-answer placeholder="Correct Answer" />
                    <input type="text" data-correct-answer placeholder="Correct Answer" />
                </div>
                <div id="incorrect-answers" class="input-group">
                    <div class="input-group row" data-incorrect-answer>
                        <input type="text" placeholder="Incorrect Answer" />
                        <input type="text" data-incorrect-answer-reason placeholder="Reason" />
                    </div>
                    <div class="input-group row" data-incorrect-answer>
                        <input type="text" placeholder="Incorrect Answer" />
                        <input type="text" data-incorrect-answer-reason placeholder="Reason" />
                    </div>
                </div>
                <input type="file" />
                <button id="paste">Paste</button>
                <div class="description"></div>
                ${isMultiple ? '' : `${allowMultiple ? '<div id="submit-exit" class="input-group row">' : ''}
                    <button id="submit">Create</button>
                    <button id="next">Next Question</button>
                    <button id="exit">Exit</button>
                ${allowMultiple ? '</div>' : ''}`}
            `;
            document.querySelector('.uploaders').appendChild(uploader);
            uploader.querySelector('[data-question-number]').select();
            const inputElement = uploader.querySelector('input[type="file"]');
            const questionElement = uploader.querySelector('input[type="file"]');
            const pond = FilePond.create(inputElement, {
                server,
                credits: false,
                allowMultiple: (question || segment) ? true : false,
                instantUpload: (question || segment) ? false : true,
                acceptedFileTypes: (course || question || segment) ? ['image/*'] : syllabus ? ['image/*', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] : ['text/csv'],
                itemInsertLocation: 'after',
                allowPaste: isMultiple ? false : true,
                maxParallelUploads: 1,
            });
            pond.on('addfile', (error, item) => {
                if (error) return;
                const existingFiles = pond.getFiles().filter(f => f.id !== item.id);
                for (const file of existingFiles) {
                    if (file.filename === item.filename && file.fileSize === item.fileSize) {
                        pond.removeFile(item.id);
                        return;
                    };
                };
            });
            pond.on('initfile', (item) => {
                if (question) item.setMetadata('question', question);
                if (segment) item.setMetadata('segment', segment);
                if (syllabus) item.setMetadata('course', syllabus);
                if (period) item.setMetadata('period', period);
                if (course) item.setMetadata('course', course);
                if (platform) item.setMetadata('platform', platform);
                if (uploaderQuestionId && (uploader.querySelector('[data-question-number]').value || uploaderQuestion)) item.setMetadata('startingQuestionId', uploaderQuestionId);
                if (uploaderQuestionId && (uploader.querySelector('[data-question-number]').value || uploaderQuestion)) item.setMetadata('startingQuestion', uploader.querySelector('[data-question-number]').value || uploaderQuestion);
            });
            pond.on('processfilestart', (file) => {
                if (uploaderQuestionId && uploaderQuestion && !file.getMetadata('title')) {
                    file.setMetadata('title', uploader.querySelector('[data-question-text]').value || uploaderQuestion);
                    file.setMetadata('correctAnswers', JSON.stringify([...uploader.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || []));
                    file.setMetadata('incorrectAnswers', JSON.stringify([...uploader.querySelectorAll('[data-incorrect-answer]')].map(a => {
                        return { 'answer': a.querySelector('input').value, 'reason': a.querySelector('input[data-incorrect-answer-reason]').value };
                    }).filter(a => a.answer !== '' && a.reason !== '') || []));
                    file.setMetadata('description', JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}');
                    pond.processFile(file);
                };
            });
            pond.on('processfiles', (error, file) => {
                if (error) return;
                if (document.querySelectorAll('.uploader').length === 1) {
                    window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
                    setTimeout(() => {
                        window.close();
                    }, 500);
                };
            });
            if (!navigator.clipboard) uploader.querySelector('#paste').remove();
            uploader.querySelector('#paste').addEventListener('click', async () => {
                var items = await navigator.clipboard.read();
                if (!items) return alert('No items found in clipboard.');
                items = items.filter(item => item.types.find(type => type.startsWith('image/')));
                const item = items[0];
                if (!item) return alert('No image found in clipboard.');
                pond.addFile(await item.getType(item.types.filter(type => type.startsWith('image/'))[0]));
            });
            var quill = null;
            if (!uploaderQuestionId || !uploaderQuestion) {
                uploader.querySelectorAll('.input-group').forEach(e => e.remove());
                uploader.querySelector('.description').remove();
                uploader.querySelector('#submit').remove();
                uploader.querySelector('#next').remove();
                uploader.querySelector('#exit').remove();
            } else {
                var textareaContainer = uploader.querySelector('.description')
                var toolbar = document.createElement('div');
                toolbar.innerHTML = `<div id="toolbar-container">
                    <span class="ql-formats">
                        <select class="ql-font" tooltip="Font"></select>
                        <select class="ql-size" tooltip="Text Size"></select>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-bold" tooltip="Bold"></button>
                        <button class="ql-italic" tooltip="Italic"></button>
                        <button class="ql-underline" tooltip="Underline"></button>
                        <button class="ql-strike" tooltip="Strikethrough"></button>
                        <button class="ql-faz-emoji" tooltip="Emoji"></button>
                    </span>
                    <span class="ql-formats">
                        <select class="ql-color" tooltip="Text Color"></select>
                        <select class="ql-background" tooltip="Highlight"></select>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-script" value="sub" tooltip="Subscript"></button>
                        <button class="ql-script" value="super" tooltip="Superscript"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-header" value="1" tooltip="Heading"></button>
                        <button class="ql-header" value="2" tooltip="Subheading"></button>
                        <button class="ql-blockquote" tooltip="Blockquote"></button>
                        <button class="ql-code-block" tooltip="Code Block"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-list" value="ordered" tooltip="Number List"></button>
                        <button class="ql-list" value="bullet" tooltip="Bullet List"></button>
                        <button class="ql-indent" value="-1" tooltip="Remove Indent"></button>
                        <button class="ql-indent" value="+1" tooltip="Indent"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-direction" value="rtl" tooltip="Text Direction"></button>
                        <select class="ql-align" tooltip="Alignment"></select>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-link" tooltip="Link"></button>
                        <button class="ql-image" tooltip="Image"></button>
                        <button class="ql-video" tooltip="Video"></button>
                        <button class="ql-formula" tooltip="LaTeX"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-clean" tooltip="Clear Formatting"></button>
                        <button data-clear-rich-content tooltip="Clear Description"><i class="bi bi-x-lg"></i></button>
                    </span>
                    <span class="ql-formats">
                        <button data-export-rich-content tooltip="Export To Clipboard"><i class="bi bi-clipboard-fill"></i></button>
                        <button data-import-rich-content tooltip="Import From Clipboard"><i class="bi bi-clipboard-plus-fill"></i></button>
                    </span>
                    <span class="ql-formats">
                        <button data-undo-rich-content tooltip="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button data-redo-rich-content tooltip="Redo"><i class="bi bi-arrow-clockwise"></i></button>
                    </span>
                </div>`;
                textareaContainer.appendChild(toolbar);
                var textarea = document.createElement('div');
                textareaContainer.appendChild(textarea);
                quill = new Quill(textarea, {
                    modules: {
                        syntax: true,
                        toolbar,
                        fazEmoji: {
                            collection: 'fluent-emoji',
                        },
                    },
                    placeholder: 'Add some written content...',
                    theme: 'snow'
                });
                quill.on('text-change', (delta) => {
                    var pastedLatex = delta.ops.find(op => Object.keys(op).includes('insert'))?.insert;
                    if (pastedLatex && (typeof pastedLatex === 'string')) {
                        const latexMatches = [...pastedLatex.matchAll(/(\$\$(.+?)\$\$)|(?<!\\)\$(.+?)(?<!\\)\$/gs)];
                        latexMatches.forEach(match => {
                            const fullMatch = match[0];
                            const innerLatex = match[2] || match[3];
                            const index = pastedLatex.indexOf(fullMatch);
                            quill.deleteText(quill.getSelection(true)?.index + index, fullMatch.length);
                            quill.insertEmbed(quill.getSelection(true)?.index + index, 'formula', innerLatex);
                            pastedLatex = pastedLatex.replace(fullMatch, ' ');
                        });
                        pastedLatex = pastedLatex.replace(/(?<!\\)\$/g, '');
                    }
                });
                uploader.querySelectorAll('[data-undo-rich-content]').forEach(a => a.addEventListener('click', () => {
                    quill.history.undo();
                }));
                uploader.querySelectorAll('[data-redo-rich-content]').forEach(a => a.addEventListener('click', () => {
                    quill.history.redo();
                }));
                uploader.querySelectorAll('[data-export-rich-content]').forEach(a => a.addEventListener('click', () => {
                    navigator.clipboard.writeText(JSON.stringify(quill.getContents())).then(() => {
                        ui.toast("Content copied to clipboard.", 3000, "success", "bi bi-clipboard-check-fill");
                    }).catch((err) => {
                        console.error('Failed to copy content: ', err);
                        ui.toast("Failed to copy content to clipboard.", 5000, "error", "bi bi-exclamation-triangle-fill");
                    });
                }));
                uploader.querySelectorAll('[data-import-rich-content]').forEach(a => a.addEventListener('click', () => {
                    navigator.clipboard.readText().then((text) => {
                        try {
                            const content = JSON.parse(text);
                            if (!text || !text.includes("ops") || !content) return ui.toast("Invalid clipboard content.", 5000, "error", "bi bi-exclamation-triangle-fill");
                            quill.setContents(content);
                            ui.toast("Content imported from clipboard.", 3000, "success", "bi bi-clipboard-check-fill");
                        } catch (err) {
                            console.error('Failed to parse content: ', err);
                            ui.toast("Failed to parse content from clipboard.", 5000, "error", "bi bi-exclamation-triangle-fill");
                        }
                    }).catch((err) => {
                        console.error('Failed to read clipboard: ', err);
                        ui.toast("Failed to read content from clipboard.", 5000, "error", "bi bi-exclamation-triangle-fill");
                    });
                }));
            };
            uploaders.push({ uploader, pond, quill, uploaderQuestionId, uploaderQuestion });
            uploader.querySelector('#submit')?.addEventListener('click', submitAllUploaders);
            uploader.querySelector('#add-answers').addEventListener('click', async () => {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Correct Answer';
                input.setAttribute('data-correct-answer', '');
                uploader.querySelector('#correct-answers').appendChild(input);
                const group = document.createElement('div');
                group.classList.add('input-group', 'row');
                group.setAttribute('data-incorrect-answer', '');
                const input2 = document.createElement('input');
                input2.type = 'text';
                input2.placeholder = 'Incorrect Answer';
                group.appendChild(input2);
                const reason = document.createElement('input');
                reason.type = 'text';
                reason.placeholder = 'Reason';
                reason.setAttribute('data-incorrect-answer-reason', '');
                group.appendChild(reason);
                uploader.querySelector('#incorrect-answers').appendChild(group);
            });
            uploader.querySelector('#remove-answers').addEventListener('click', async () => {
                [...uploader.querySelectorAll('[data-correct-answer]')].filter(e => e.value === '').forEach(e => e.remove());
                [...uploader.querySelectorAll('[data-incorrect-answer]')].filter(e => e.querySelector('input').value === '' && e.querySelector('input[data-incorrect-answer-reason]').value === '').forEach(e => e.remove());
            });
            uploader.querySelector('#ai').addEventListener('click', async () => {
                var images = [];
                var pondFiles = pond.getFiles();
                if (pondFiles.length !== 0) {
                    const readPromises = pondFiles.map(file => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = function () {
                                resolve(reader.result);
                            };
                            reader.onerror = reject;
                            if (file.file) reader.readAsDataURL(file.file);
                            else resolve(null);
                        });
                    });
                    images = await Promise.all(readPromises);
                };
                images = images.filter(image => image !== null);
                images = [...new Set(images)];
                var description = quill.getText().replaceAll('\\n', ' ').replaceAll('  ', ' ').trim() || null;
                if (images.length || description) {
                    startLoader();
                    await fetch(domain + '/ai/q', {
                        method: 'POST',
                        body: JSON.stringify({
                            OpenAI_API_Key: "sk-proj-18b3a02f4fb35e8a8421948667fbacf7_2ac9b775227456bb9d53d370cc299da7937deb6b_184751e482b7_f157c538a800",
                            title: uploader.querySelector('[data-question-text]').value || uploaderQuestion,
                            description,
                            images,
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(res => res.json())
                        .then(data => {
                            stopLoader();
                            const output = data.o;
                            if (data.error || !data.o) {
                                uploader.querySelector('#ai').classList.add('error');
                                setTimeout(() => {
                                    uploader.querySelector('#ai').classList.remove('error');
                                }, 2000);
                                alert(data.error);
                            } else {
                                const aiCorrectAnswers = output.correct || [];
                                const aiIncorrectAnswers = output.incorrect || [];
                                [...uploader.querySelectorAll('[data-correct-answer]')].filter(e => e.value === '').forEach(e => e.remove());
                                [...uploader.querySelectorAll('[data-incorrect-answer]')].filter(e => e.querySelector('input').value === '' && e.querySelector('input[data-incorrect-answer-reason]').value === '').forEach(e => e.remove());
                                aiCorrectAnswers.forEach(answer => {
                                    if (!answer || [...uploader.querySelectorAll('[data-correct-answer]')].find(e => e.value.toLowerCase() === answer.toLowerCase())) return;
                                    const input = document.createElement('input');
                                    input.type = 'text';
                                    input.value = answer;
                                    input.setAttribute('data-correct-answer', '');
                                    uploader.querySelector('#correct-answers').appendChild(input);
                                });
                                aiIncorrectAnswers.forEach(answer => {
                                    if (!answer.answer || !answer.reason || [...uploader.querySelectorAll('[data-incorrect-answer] input:not([data-incorrect-answer-reason])')].find(e => e.value.toLowerCase() === answer.answer.toLowerCase())) return;
                                    const group = document.createElement('div');
                                    group.classList.add('input-group', 'row');
                                    group.setAttribute('data-incorrect-answer', '');
                                    const input = document.createElement('input');
                                    input.type = 'text';
                                    input.value = answer.answer;
                                    group.appendChild(input);
                                    const reason = document.createElement('input');
                                    reason.type = 'text';
                                    reason.value = answer.reason;
                                    reason.setAttribute('data-incorrect-answer-reason', '');
                                    group.appendChild(reason);
                                    uploader.querySelector('#incorrect-answers').appendChild(group);
                                });
                                uploader.querySelector('#ai').classList.add('success');
                                setTimeout(() => {
                                    uploader.querySelector('#ai').classList.remove('success');
                                }, 2000);
                            };
                        })
                        .catch(error => {
                            uploader.querySelector('#ai').classList.add('error');
                            setTimeout(() => {
                                uploader.querySelector('#ai').classList.remove('error');
                            }, 2000);
                            alert(error);
                        });
                } else {
                    alert('Image(s) or description required.');
                    uploader.querySelector('#ai').classList.add('error');
                    setTimeout(() => {
                        uploader.querySelector('#ai').classList.remove('error');
                    }, 2000);
                    return;
                };
            });
            uploader.querySelector('#copy')?.addEventListener('click', () => {
                createUploader(null, uploader.querySelector('[data-question-number]').value || uploaderQuestion);
            });
            uploader.querySelector('#next')?.addEventListener('click', next);
            uploader.querySelector('#exit')?.addEventListener('click', exit);
            uploader.querySelector('#remove')?.addEventListener('click', () => {
                if (confirm('Are you sure you want to remove this question? If it has unsaved data, all will be deleted.')) uploader.remove();
            });
            uploader.querySelector('#stem')?.addEventListener('click', () => {
                document.querySelectorAll('#stem').forEach(stem => {
                    if (stem !== uploader.querySelector('#stem')) {
                        stem.classList.remove('active');
                    } else {
                        stem.classList.add('active');
                    };
                });
                ui.toast(`Stem set to Question ${uploader.querySelector('[data-question-number]').value || uploaderQuestion}.`, 3000, "info", "bi bi-diagram-3-fill");
            });
        };
        async function submitAllUploaders() {
            document.querySelector('#submit').disabled = true;
            document.querySelector('#next').disabled = true;
            document.querySelector('#exit').disabled = true;
            var submitSuccess = true;
            document.querySelector('#submit').innerText = 'Submitting';
            for (const { uploader, pond, quill, uploaderQuestionId, uploaderQuestion } of uploaders) {
                // console.log(pond.getFiles())
                if (pond.getFiles().length != 0) await pond.processFiles();
                await fetch(server, {
                    method: 'POST',
                    body: JSON.stringify({
                        question: question || null,
                        segment: segment || null,
                        course: syllabus || null,
                        period: period || null,
                        startingQuestionId: uploader.id || uploaderQuestionId || null,
                        startingQuestion: uploader.querySelector('[data-question-number]').value || uploaderQuestion || null,
                        description: JSON.stringify(quill.getContents()) || '{"ops":[{"insert":"\n"}]}',
                        title: uploader.querySelector('[data-question-text]').value || uploader.querySelector('[data-question-number]').value || uploaderQuestion,
                        correctAnswers: [...uploader.querySelectorAll('[data-correct-answer]')].map(a => a.value).filter(Boolean) || [],
                        incorrectAnswers: [...uploader.querySelectorAll('[data-incorrect-answer]')].map(a => {
                            return { 'answer': a.querySelector('input').value, 'reason': a.querySelector('input[data-incorrect-answer-reason]').value };
                        }).filter(a => a.answer !== '' && a.reason !== '') || [],
                        stem: (!uploader.querySelector('#stem') || uploader.querySelector('#stem')?.classList.contains('active')) ? null : (document.querySelector('.uploader:has(#stem.active)')?.id || null),
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) submitSuccess = false;
                    });
            };
            document.querySelector('#submit').disabled = false;
            document.querySelector('#next').disabled = false;
            document.querySelector('#exit').disabled = false;
            if (submitSuccess) {
                document.querySelector('#submit').innerText = 'Success';
                document.querySelector('#submit').classList.add('success');
                document.querySelector('#next').style.display = 'block';
                document.querySelector('#exit').style.display = 'block';
                setTimeout(() => {
                    document.querySelector('#submit').innerText = 'Save';
                    document.querySelector('#submit').classList.remove('success');
                }, 2000);
            } else {
                document.querySelector('#submit').classList.add('error');
                setTimeout(() => {
                    document.querySelector('#submit').classList.remove('error');
                }, 2000);
                alert(data.error);
            };
            window.opener.postMessage('uploadSuccess', window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : ''));
        }
        window.onload = createUploader;
    </script>
</body>

</html>